name: Claude Code Action

on:
  workflow_call:
    inputs:
      prompt:
        required: false
        description: "Prompt to send to Claude. If not set, starts with interactive mode. (@claude mode)"
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
        description: "OAuth token for Claude Code GitHub App"

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read # Required for Claude to read CI results on PRs

jobs:
  run-claude-code:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      DISABLE_BUG_COMMAND: "1"
      DISABLE_ERROR_REPORTING: "1"
      DISABLE_TELEMETRY: "1"

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Start Claude Code with interactive mode
        uses: anthropics/claude-code-action@v1
        if: ${{ inputs.prompt == '' }}
        with:
          branch_prefix: "claude-"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools WebSearch

      - name: Start Claude Code with automated mode
        uses: anthropics/claude-code-action@v1
        if: ${{ inputs.prompt != '' }}
        with:
          branch_prefix: "claude-"
          prompt: ${{ inputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools WebSearch
